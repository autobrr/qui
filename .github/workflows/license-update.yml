name: Check for missing License Headers
description: Automatically adds missing license headers and create PR if changes needed

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-licenses:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create update prompt
        run: |
          mkdir -p /tmp/claude-prompts
          cat > /tmp/claude-prompts/update-prompt.txt << 'EOF'
          You're a license header check assistant. Your task is to run the license update script and create/update a PR if changes are needed.

          TASK OVERVIEW:

          1. Check if there's an existing open PR for license updates:
             - Run: gh pr list --state open --label "missing-headers" --json number,headRefName
             - If a PR exists, note the PR number and branch name

          2. If an existing PR branch exists:
             - Checkout that branch: git checkout <branch-name>
             - Pull latest changes from main: git pull origin main --rebase
          
          3. If no existing PR branch:
             - Create a new branch: git checkout -b chore/missing-license-headers-$(date +%Y%m%d)

          4. Run the license update script:
             - Run it: python3 update-headers.pyh
             - Check the output to see if any files were updated

          5. If files were updated:
             a. Configure git:
                - git config user.name "github-actions[bot]"
                - git config user.email "github-actions[bot]@users.noreply.github.com"
             
             b. Commit the changes:
                - git add -A
                - git commit -m "chore: add missing license headers"
             
             c. Push the branch:
                - git push origin HEAD
             
             d. Create or update the PR:
                - If no existing PR, create one:
                  gh pr create \
                    --title "chore: add missing license headers" \
                    --body "This PR automatically adds missing license headers across the codebase.
          
          Generated by the license-update workflow." \
                    --label "missing-headers" \
                    --label "automated"
                
                - If existing PR, just push commits (already done in step c)

          6. If no files were updated:
             - If an existing PR exists, close it with a comment:
               gh pr close <pr-number> --comment "All license headers are up to date. Closing this PR."
             - Otherwise, just exit successfully

          IMPORTANT:
          - Be thorough in checking for existing PRs
          - Use the exact commands provided
          - Only create a PR if files were actually changed
          EOF

      - name: Run Claude Code for License Header Check
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt_file: /tmp/claude-prompts/update-prompt.txt
          allowed_tools: "Bash"
          timeout_minutes: "8"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_env: |
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}